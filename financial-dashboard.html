<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Chart.js Global Configuration
    Chart.defaults.font.family = "'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif";
    Chart.defaults.color = '#64748b'; // text-tertiary color
    Chart.defaults.plugins.legend.labels.usePointStyle = true;
    Chart.defaults.plugins.legend.labels.pointStyle = 'circle';
    
    // November transactions data
    const novemberTransactions = [
        { date: '11/8/24', account: 'RBC Online Banking (RBC Advantage Banking)', description: 'Contactless Interac purchase - 8827 COSTCO WHOLESAL', category: 'General Merchandise', type: 'withdrawal', amount: -104.5 },
        { date: '11/8/24', account: 'CIBC Online Banking (Recommended) (Chequing)', description: 'Electronic Funds Transfer PREAUTHORIZED DEBIT BELL ALIANT', category: 'Transfers', type: 'transfer', amount: -200.0 },
        { date: '11/7/24', account: 'RBC Online Banking (RBC Advantage Banking)', description: 'Loan payment', category: null, type: 'withdrawal', amount: -1045.8 },
        { date: '11/7/24', account: 'RBC Online Banking (RBC Advantage Banking)', description: 'ATM Withdrawal', category: null, type: 'withdrawal', amount: -16.5 },
        { date: '11/7/24', account: 'RBC Online Banking (RBC Cash Back Mastercard)', description: 'Credit Card Payment', category: 'Credit Card Payments', type: 'transfer', amount: 1000.00 },
        { date: '11/6/24', account: 'CIBC Online Banking (Recommended) (CIBC VISA)', description: 'Restaurant Purchase', category: 'Restaurants/Dining', type: 'withdrawal', amount: -52.36 },
        { date: '11/6/24', account: 'CIBC Online Banking (Recommended) (CIBC VISA)', description: 'Service Fee', category: 'Service Charges/Fees', type: 'fee', amount: -5.00 },
        { date: '11/6/24', account: 'RBC Online Banking (RBC Cash Back Mastercard)', description: 'Gasoline Purchase', category: 'Gasoline/Fuel', type: 'withdrawal', amount: -46.79 },
        { date: '11/5/24', account: 'RBC Online Banking (RBC Advantage Banking)', description: 'ATM Withdrawal', category: null, type: 'withdrawal', amount: -200.00 },
        { date: '11/5/24', account: 'CIBC Online Banking (Recommended) (Chequing)', description: 'Mobile Deposit', category: null, type: 'deposit', amount: 856.23 },
        { date: '11/5/24', account: 'CIBC Online Banking (Recommended) (CIBC VISA)', description: 'Shopping - Clothing', category: 'Clothing/Shoes', type: 'withdrawal', amount: -89.32 },
        { date: '11/4/24', account: 'CIBC Online Banking (Recommended) (CIBC VISA)', description: 'Gas Station Purchase', category: 'Automotive Expenses', type: 'withdrawal', amount: -67.85 },
        { date: '11/4/24', account: 'RBC Online Banking (RBC Advantage Banking)', description: 'Utility Bill Payment', category: 'Utilities', type: 'withdrawal', amount: -145.32 },
        { date: '11/4/24', account: 'CIBC Online Banking (Recommended) (Savings)', description: 'Transfer from Savings', category: 'Transfers', type: 'transfer', amount: 500.00 },
        { date: '11/3/24', account: 'CIBC Online Banking (Recommended) (CIBC VISA)', description: 'Credit Card Payment', category: 'Credit Card Payments', type: 'transfer', amount: 200.00 },
        { date: '11/3/24', account: 'CIBC Online Banking (Recommended) (Chequing)', description: 'Grocery Shopping', category: 'Groceries', type: 'withdrawal', amount: -142.76 },
        { date: '11/2/24', account: 'RBC Online Banking (RBC Advantage Banking)', description: 'Restaurant Dining', category: 'Restaurants/Dining', type: 'withdrawal', amount: -56.78 },
        { date: '11/2/24', account: 'RBC Online Banking (RBC Cash Back Mastercard)', description: 'Online Subscription', category: 'Online Services', type: 'withdrawal', amount: -14.99 },
        { date: '11/1/24', account: 'RBC Online Banking (RBC Advantage Banking)', description: 'Payroll Deposit', category: null, type: 'deposit', amount: 1808.68 },
        { date: '11/1/24', account: 'CIBC Online Banking (Recommended) (Chequing)', description: 'Mortgage Payment', category: 'Transfers', type: 'transfer', amount: -1050.00 },
        { date: '11/1/24', account: 'CIBC Online Banking (Recommended) (CIBC VISA)', description: 'Home Improvement Store', category: 'Home Improvement', type: 'withdrawal', amount: -264.39 }
    ];
    
    // Account data
    const accountsData = {
        labels: ['RBC Advantage', 'CIBC Chequing', 'RBC Mastercard', 'CIBC VISA', 'CIBC Savings'],
        balances: [-1718.09, 1118.11, -304.35, -1083.24, -1674.63]
    };
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        initializeCashFlowChart();
        initializeAccountsChart();
        populateTransactionsTable();
    });
    
    // Initialize Cash Flow Chart
    function initializeCashFlowChart() {
        const ctx = document.getElementById('cash-flow-chart').getContext('2d');
        
        // Calculate data for chart
        const income = novemberTransactions
            .filter(t => t.type === 'deposit')
            .reduce((sum, t) => sum + t.amount, 0);
            
        const expenses = Math.abs(novemberTransactions
            .filter(t => t.type === 'withdrawal')
            .reduce((sum, t) => sum + t.amount, 0));
            
        const transfers = novemberTransactions
            .filter(t => t.type === 'transfer')
            .reduce((sum, t) => sum + t.amount, 0);
            
        const fees = Math.abs(novemberTransactions
            .filter(t => t.type === 'fee')
            .reduce((sum, t) => sum + t.amount, 0));
        
        new Chart(ctx, {
            type: 'pie', // Changed from doughnut to pie for better space usage
            data: {
                labels: ['Income', 'Expenses', 'Transfers', 'Fees'],
                datasets: [{
                    data: [income, expenses, transfers, fees],
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.7)',  // Success
                        'rgba(239, 68, 68, 0.7)',   // Danger
                        'rgba(14, 165, 233, 0.7)',  // Primary
                        'rgba(245, 158, 11, 0.7)'   // Warning
                    ],
                    borderColor: [
                        'rgb(16, 185, 129)',
                        'rgb(239, 68, 68)',
                        'rgb(14, 165, 233)',
                        'rgb(245, 158, 11)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        bottom: 10 // Add padding to ensure labels fit
                    }
                },
                plugins: {
                    legend: {
                        position: 'top', // Move legend to top to avoid overflow
                        labels: {
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#0f172a',
                        bodyColor: '#334155',
                        bodyFont: { 
                            size: 14 
                        },
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round(value / total * 100);
                                return `$${value.toLocaleString(undefined, {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                })} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Initialize Accounts Chart
    function initializeAccountsChart() {
        const ctx = document.getElementById('accounts-chart').getContext('2d');
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: accountsData.labels,
                datasets: [{
                    label: 'Account Balance',
                    data: accountsData.balances,
                    backgroundColor: accountsData.balances.map(balance => 
                        balance >= 0 
                            ? 'rgba(16, 185, 129, 0.7)'   // Success
                            : 'rgba(239, 68, 68, 0.7)'    // Danger
                    ),
                    borderColor: accountsData.balances.map(balance => 
                        balance >= 0 
                            ? 'rgb(16, 185, 129)'
                            : 'rgb(239, 68, 68)'
                    ),
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)'
                        },
                        ticks: {
                            callback: function(value) {
                                if (value === 0) return '$0';
                                return (value > 0 ? '+$' : '-$') + Math.abs(value).toLocaleString();
                            }
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#0f172a',
                        bodyColor: '#334155',
                        bodyFont: { 
                            size: 14 
                        },
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            title: function(context) {
                                return context[0].label + ' Account';
                            },
                            label: function(context) {
                                const value = context.raw;
                                const prefix = value >= 0 ? '+' : '-';
                                return `Balance: ${prefix}$${Math.abs(value).toLocaleString(undefined, {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                })}`;
                            },
                            footer: function(context) {
                                const value = context[0].raw;
                                return value >= 0 ? 'Positive Balance' : 'Negative Balance';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Populate transactions table
    function populateTransactionsTable() {
        const tableBody = document.querySelector('#transactions-table tbody');
        
        // Sort transactions by date (newest first)
        const sortedTransactions = [...novemberTransactions].sort((a, b) => {
            return new Date(b.date) - new Date(a.date);
        });
        
        sortedTransactions.forEach(transaction => {
            const row = document.createElement('tr');
            
            // Format amount as currency
            const formattedAmount = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(transaction.amount);
            
            // Generate account initials and determine color
            const accountName = transaction.account.split(' (')[0];
            const accountInitials = accountName
                .split(' ')
                .map(word => word[0])
                .join('')
                .substring(0, 2)
                .toUpperCase();
            
            // Set account color based on account name
            let accountColor;
            if (accountName.includes('RBC Advantage')) {
                accountColor = '#ef4444';
            } else if (accountName.includes('CIBC Chequing')) {
                accountColor = '#10b981';
            } else if (accountName.includes('RBC Cash Back')) {
                accountColor = '#f59e0b';
            } else if (accountName.includes('CIBC VISA')) {
                accountColor = '#8b5cf6';
            } else if (accountName.includes('CIBC Savings')) {
                accountColor = '#0ea5e9';
            } else {
                accountColor = '#64748b';
            }
            
            // Create row content
            row.innerHTML = `
                <td>${transaction.date}</td>
                <td>
                    <div class="account-cell">
                        <div class="account-icon" style="background-color: ${accountColor};">${accountInitials}</div>
                        <div>${accountName}</div>
                    </div>
                </td>
                <td>${transaction.description}</td>
                <td>${transaction.category || 'Uncategorized'}</td>
                <td>
                    <span class="tx-badge badge-${transaction.type}">
                        ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
                    </span>
                </td>
                <td class="${transaction.amount >= 0 ? 'positive' : 'negative'}">${formattedAmount}</td>
            `;
            
            tableBody.appendChild(row);
        });
    }
</script>
