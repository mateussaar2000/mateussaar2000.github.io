--- START OF FILE financial-dashboard.html ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard</title> <!-- Specific Title -->

    <!-- CSS Dependencies: Font Awesome (for sidebar/icons) -->
    <link
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        rel="stylesheet"
    />

    <style>
        /* --- Base & Layout Styles (COPIED FROM index.html) --- */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --accent-primary: #0284c7;
            --accent-secondary: #0ea5e9;
            --border-color: #e2e8f0;
            --sidebar-width: 250px;
            --header-height: 60px;
            --transition-speed: 0.3s;
            --font-primary: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            /* Add dashboard specific vars here */
            --bg-tertiary: #f1f5f9;
            --text-tertiary: #64748b;
            --accent-tertiary: #38bdf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border-radius: 12px;
            --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-primary); }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-size: 16px; line-height: 1.5; }
        .layout { display: flex; min-height: 100vh; }

        /* --- Sidebar Styling (COPIED FROM index.html) --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; z-index: 10; transition: transform var(--transition-speed); }
        .sidebar-header { padding: 1.5rem; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); height: var(--header-height); }
        .sidebar-logo { font-size: 1.25rem; font-weight: 700; color: var(--accent-primary); text-decoration: none; }
        .sidebar-nav { padding: 1rem 0; }
        .nav-section { margin-bottom: 1rem; }
        .nav-section-title { padding: 0.5rem 1.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); font-weight: 600; }
        .nav-items { list-style: none; }
        .nav-item { margin: 0.25rem 0; }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--text-secondary); text-decoration: none; transition: background-color var(--transition-speed), color var(--transition-speed); border-left: 3px solid transparent; }
        .nav-link:hover { background-color: rgba(0, 0, 0, 0.05); color: var(--accent-primary); }
        .nav-link.active { color: var(--accent-primary); border-left-color: var(--accent-primary); background-color: rgba(2, 132, 199, 0.1); font-weight: 500; }
        .nav-icon { margin-right: 0.75rem; width: 20px; text-align: center; }

        /* --- Main Content Area Styling (COPIED FROM index.html) --- */
         .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 2rem; min-height: 100vh; }
         .page-header { height: var(--header-height); background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 2rem; margin: -2rem -2rem 2rem -2rem; }
         .page-header-title { font-size: 1.25rem; font-weight: 600; }


        /* --- Mobile Responsiveness (COPIED FROM index.html) --- */
        .sidebar-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; color: var(--text-secondary); position: fixed; top: 10px; left: 10px; z-index: 20; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1rem; margin-top: 50px;}
            .page-header { margin: -1rem -1rem 1rem -1rem; padding: 0 1rem; }
            .sidebar-toggle { display: block; }
        }

        /* --- Styles SPECIFIC to Financial Dashboard (Copied from original dashboard file) --- */
        /* .dashboard { max-width: 1440px; margin: 0 auto; } */ /* No longer needed if .main-content handles layout */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .dashboard-title h1 { font-size: 1.5rem; /* Adjusted size to fit potentially smaller header */ font-weight: 700; margin-bottom: 0.25rem; color: var(--accent-primary); }
        .dashboard-title p { color: var(--text-secondary); font-size: 0.9rem; }
        .dashboard-meta { display: flex; align-items: center; gap: 1.5rem; }
        .dashboard-meta-item { text-align: right; }
        .dashboard-meta-value { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .dashboard-meta-label { font-size: 0.7rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; } /* Responsive grid */
        .card { background-color: var(--bg-secondary); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); transition: transform var(--transition-speed), box-shadow var(--transition-speed); position: relative; overflow: hidden; border: 1px solid var(--border-color); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); }
        .card::after { content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .card-income::after { background: linear-gradient(to bottom, var(--success), transparent); }
        .card-expense::after { background: linear-gradient(to bottom, var(--danger), transparent); }
        .card-transfer::after { background: linear-gradient(to bottom, var(--accent-primary), transparent); }
        .card-net::after { background: linear-gradient(to bottom, var(--accent-secondary), transparent); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .card-title { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem; font-weight: 500; }
        .card-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; flex-shrink: 0; }
        .card-income .card-icon { background-color: rgba(16, 185, 129, 0.1); color: var(--success); }
        .card-expense .card-icon { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .card-transfer .card-icon { background-color: rgba(14, 165, 233, 0.1); color: var(--accent-primary); }
        .card-net .card-icon { background-color: rgba(6, 182, 212, 0.1); color: var(--accent-secondary); }
        .card-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.1; }
        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .neutral { color: var(--accent-primary); }
        .card-subtitle { font-size: 0.75rem; color: var(--text-tertiary); }
        .chart-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; } /* Responsive grid */
        .chart-card { background-color: var(--bg-secondary); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
        .chart-header { margin-bottom: 1rem; }
        .chart-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--text-primary); }
        .chart-subtitle { font-size: 0.875rem; color: var(--text-tertiary); }
        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 1rem; }
        .transactions-card { background-color: var(--bg-secondary); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); margin-bottom: 2rem; border: 1px solid var(--border-color); }
        .transactions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .transactions-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }
        .table-container { overflow-x: auto; max-height: 500px; overflow-y: auto; }
        .transactions-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 700px; }
        .transactions-table th { background-color: var(--bg-tertiary); padding: 1rem; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1; }
        .transactions-table th:first-child { border-top-left-radius: 8px; }
        .transactions-table th:last-child { border-top-right-radius: 8px; }
        .transactions-table td { padding: 1rem; font-size: 0.875rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        /* Allow description to wrap */
        .transactions-table td:nth-child(3) { white-space: normal; min-width: 250px; }
        .transactions-table tr:last-child td { border-bottom: none; }
        .transactions-table tr:hover td { background-color: var(--bg-tertiary); }
        .account-cell { display: flex; align-items: center; gap: 0.75rem; }
        .account-icon { width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: white; background-color: var(--text-tertiary); flex-shrink: 0; }
        .tx-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize; }
        .badge-deposit { background-color: rgba(16, 185, 129, 0.1); color: var(--success); }
        .badge-withdrawal { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .badge-transfer { background-color: rgba(14, 165, 233, 0.1); color: var(--accent-primary); }
        .badge-fee { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
        /* Add style for interest if needed, mapping to deposit for now */
        .badge-interest { background-color: rgba(16, 185, 129, 0.1); color: var(--success); }

        .dashboard-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-tertiary); margin-top: 2rem; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb { background: var(--accent-tertiary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

        /* Loading/Error Message Style */
        .message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 250, 252, 0.8); /* --bg-primary with opacity */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            padding: 2rem;
            text-align: center;
            font-size: 1.1rem;
            color: var(--text-secondary);
            border-radius: var(--border-radius); /* Match card radius */
        }

    </style>
</head>
<body>
    <!-- Button to toggle sidebar on mobile -->
    <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="layout">
        <!-- Sidebar Navigation (DUPLICATED STRUCTURE) -->
        <aside class="sidebar" id="sidebar">
             <div class="sidebar-header">
                 <a href="index.html" class="sidebar-logo">My Website</a> <!-- Link back to home -->
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Pages</div>
                    <ul class="nav-items" id="page-nav">
                        <li class="nav-item">
                            <a href="index.html" class="nav-link"> <!-- Not active on this page -->
                                <span class="nav-icon"><i class="fas fa-home"></i></span>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="nav-item">
                             <!-- Add 'active' class MANUALLY for the current page -->
                            <a href="financial-dashboard.html" class="nav-link active">
                                <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                                <span>Financial Dashboard</span>
                            </a>
                        </li>
                         <li class="nav-item">
                            <a href="ontario_vs_calgary.html" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-map-marked-alt"></i></span>
                                <span>Ontario vs Calgary</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="Ship_Technical_Data_Network_Light.html" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-ship"></i></span>
                                <span>Ship Network Light</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="Ship_Technical_Data_Network_Dark.html" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-moon"></i></span>
                                <span>Ship Network Dark</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="newfoundland_realestate.html" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-building"></i></span>
                                <span>Newfoundland Real Estate</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Optional Header for the page -->
             <header class="page-header">
                <h1 class="page-header-title">Financial Dashboard</h1>
            </header>

            <!-- Dashboard Specific Content -->
            <div class="dashboard">
                 <!-- Loading/Error Message Area -->
                 <div id="message-area"></div>

                <div class="dashboard-header">
                    <div class="dashboard-title">
                        <h1>Financial Analysis</h1>
                        <p id="dashboard-month-year">Loading...</p>
                    </div>
                    <div class="dashboard-meta">
                         <div class="dashboard-meta-item">
                            <div class="dashboard-meta-value" id="transaction-count">--</div>
                            <div class="dashboard-meta-label">Transactions</div>
                        </div>
                         <!-- Account count might be dynamic or fixed depending on source -->
                        <div class="dashboard-meta-item">
                            <div class="dashboard-meta-value" id="account-count">5</div> <!-- Keep fixed or calculate from data -->
                            <div class="dashboard-meta-label">Accounts</div>
                        </div>
                    </div>
                </div>

                <div class="card-grid">
                     <!-- Card content will be updated by JS -->
                     <div class="card card-income"> <div class="card-header"> <div> <div class="card-title">TOTAL INCOME</div> </div> <div class="card-icon"> <i class="fas fa-arrow-down"></i> </div> </div> <div class="card-value positive" id="total-income">$0.00</div> <div class="card-subtitle" id="income-subtitle">Loading...</div> </div>
                     <div class="card card-expense"> <div class="card-header"> <div> <div class="card-title">TOTAL EXPENSES</div> </div> <div class="card-icon"> <i class="fas fa-arrow-up"></i> </div> </div> <div class="card-value negative" id="total-expenses">$0.00</div> <div class="card-subtitle" id="expense-subtitle">Loading...</div> </div>
                     <div class="card card-transfer"> <div class="card-header"> <div> <div class="card-title">NET TRANSFERS</div> </div> <div class="card-icon"> <i class="fas fa-exchange-alt"></i> </div> </div> <div class="card-value neutral" id="total-transfers">$0.00</div> <div class="card-subtitle" id="transfer-subtitle">Loading...</div> </div>
                     <div class="card card-net"> <div class="card-header"> <div> <div class="card-title">NET CASH FLOW</div> </div> <div class="card-icon"> <i class="fas fa-chart-line"></i> </div> </div> <div class="card-value" id="net-cash-flow">$0.00</div> <div class="card-subtitle" id="net-subtitle">Loading...</div> </div>
                </div>

                <div class="chart-row">
                     <div class="chart-card">
                        <div class="chart-header"> <div class="chart-title">Cash Flow</div> <div class="chart-subtitle">Income vs Expenses by Type</div> </div>
                        <div class="chart-container"> <canvas id="cash-flow-chart"></canvas> </div>
                    </div>
                     <div class="chart-card">
                        <div class="chart-header"> <div class="chart-title">Account Balances</div> <div class="chart-subtitle">Current Balance Across Accounts</div> </div>
                        <div class="chart-container"> <canvas id="accounts-chart"></canvas> </div>
                     </div>
                </div>

                 <div class="transactions-card">
                    <div class="transactions-header"> <div class="transactions-title">Recent Transactions</div> </div>
                    <div class="table-container"> <table class="transactions-table" id="transactions-table"> <thead> <tr> <th>Date</th> <th>Account</th> <th>Description</th> <th>Category</th> <th>Type</th> <th>Amount</th> </tr> </thead> <tbody> <!-- Populated by JS --> </tbody> </table> </div>
                 </div>

                 <div class="dashboard-footer"> <div>Financial Dashboard Â© 2024</div> <div>Data sourced from CSV</div> </div>
            </div>
            <!-- End Dashboard Specific Content -->

        </main>
    </div>

    <!-- JavaScript Dependencies: Chart.js (Load AFTER content) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- Dashboard Specific JavaScript (Modified for CSV Loading) -->
    <script>
        // Define month/year for filtering
        const TARGET_MONTH = 11; // November
        const TARGET_YEAR = 2024;
        const TARGET_YEAR_SHORT = '24';
        const CSV_FILE_PATH = 'wealthica-transactions-2024-11-19.csv';

        // Global variable to hold processed transaction data for the target month
        let novemberTransactions = [];
        // Static account data (or could be derived from transactions if needed)
        const accountsData = { labels: ['RBC Advantage', 'CIBC Chequing', 'RBC Mastercard', 'CIBC VISA', 'CIBC Savings'], balances: [-1718.09, 1118.11, -304.35, -1083.24, -1674.63] }; // Assuming this is still relevant/static


        // --- Utility Functions ---
        const currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'CAD', // Assuming CAD based on CSV header
            minimumFractionDigits: 2
        });

        function showMessage(type, text) {
            const messageArea = document.getElementById('message-area');
            if (!messageArea) return;
            const messageClass = type === 'error' ? 'negative' : 'neutral'; // Use existing CSS classes
            messageArea.innerHTML = `<div class="message-overlay"><p class="${messageClass}">${text}</p></div>`;
        }

        function clearMessage() {
            const messageArea = document.getElementById('message-area');
            if (messageArea) messageArea.innerHTML = '';
        }

        // --- CSV Parsing Function ---
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error("CSV file is empty or has no data rows.");
            }

            // Simple header parsing (assumes no commas in headers)
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            // Find column indices (more robust than hardcoding)
            const idx = {
                date: headers.indexOf('Trade Date'),
                account: headers.indexOf('Asset/Account'),
                description: headers.indexOf('Description'),
                type: headers.indexOf('Type'),
                category: headers.indexOf('Category'),
                amount: headers.indexOf('Amount (CAD)')
            };

            // Check if essential columns are present
            if (idx.date === -1 || idx.account === -1 || idx.description === -1 || idx.type === -1 || idx.amount === -1) {
                console.error("Missing essential columns in CSV:", headers);
                throw new Error("CSV file is missing required columns (Date, Account, Description, Type, Amount).");
            }


            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(','); // Simple split, assumes no commas within quoted fields

                // Basic check for row validity
                if (values.length >= headers.length) {
                    const amountCAD = parseFloat(values[idx.amount]?.trim());
                    if (isNaN(amountCAD)) continue; // Skip rows with invalid amount

                    // Map CSV type to dashboard type
                    let transactionType = values[idx.type]?.trim().toLowerCase() || '';
                    if (transactionType === 'interest') {
                        transactionType = 'deposit'; // Map interest to deposit for summary
                    } else if (!['withdrawal', 'deposit', 'transfer', 'fee'].includes(transactionType)) {
                        // Assign type based on amount if CSV type is unrecognized/missing
                        transactionType = amountCAD >= 0 ? 'deposit' : 'withdrawal';
                    }


                    const transaction = {
                        date: values[idx.date]?.trim() || '',
                        account: values[idx.account]?.trim() || 'Unknown Account',
                        description: values[idx.description]?.trim() || 'No Description',
                        category: values[idx.category]?.trim() || null, // Keep null if empty
                        type: transactionType,
                        amount: amountCAD
                    };
                    data.push(transaction);
                } else {
                    console.warn(`Skipping malformed CSV row ${i + 1}:`, lines[i]);
                }
            }
            return data;
        }

        // --- Filtering Function ---
        function filterTransactionsByMonth(transactions, month, yearShort) {
            return transactions.filter(t => {
                if (!t.date) return false;
                // Expects MM/DD/YY format from CSV
                const parts = t.date.split('/');
                if (parts.length === 3) {
                    const m = parseInt(parts[0], 10);
                    const y = parts[2]; // Keep as string 'YY'
                    return m === month && y === yearShort;
                }
                return false; // Invalid date format
            });
        }


        // --- Update UI Elements ---
        function updateDashboardHeader(transactions) {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('dashboard-month-year').textContent = `${monthNames[TARGET_MONTH - 1]} ${TARGET_YEAR} Transactions`;
            document.getElementById('transaction-count').textContent = transactions.length;
            // Optional: Calculate unique accounts if needed
            // const uniqueAccounts = new Set(transactions.map(t => t.account));
            // document.getElementById('account-count').textContent = uniqueAccounts.size;
        }

        function updateSummaryCards(transactions) {
            let totalIncome = 0;
            let totalExpenses = 0;
            let netTransfers = 0;
            // let totalFees = 0; // Fees are often included in expenses

            transactions.forEach(t => {
                if (t.type === 'deposit') {
                    totalIncome += t.amount;
                } else if (t.type === 'withdrawal' || t.type === 'fee') { // Include fees in expenses
                    totalExpenses += Math.abs(t.amount); // Use absolute value for expenses sum
                } else if (t.type === 'transfer') {
                    netTransfers += t.amount; // Keep sign for net transfers
                }
            });

            const netCashFlow = totalIncome - totalExpenses + netTransfers; // Note: Transfers might impact net differently depending on definition

            document.getElementById('total-income').textContent = currencyFormatter.format(totalIncome);
            document.getElementById('income-subtitle').textContent = `November deposits`;

            document.getElementById('total-expenses').textContent = currencyFormatter.format(totalExpenses * -1); // Display as negative
            document.getElementById('expense-subtitle').textContent = `November withdrawals & fees`;

            document.getElementById('total-transfers').textContent = currencyFormatter.format(netTransfers);
            document.getElementById('total-transfers').classList.toggle('positive', netTransfers >= 0);
            document.getElementById('total-transfers').classList.toggle('negative', netTransfers < 0);
            document.getElementById('transfer-subtitle').textContent = `November net transfers`;

            document.getElementById('net-cash-flow').textContent = currencyFormatter.format(netCashFlow);
            document.getElementById('net-cash-flow').classList.toggle('positive', netCashFlow >= 0);
            document.getElementById('net-cash-flow').classList.toggle('negative', netCashFlow < 0);
             document.getElementById('net-subtitle').textContent = `November net flow`;
        }


        // --- Chart/Table Initialization Functions (Modified to accept data) ---
        let cashFlowChartInstance = null;
        let accountsChartInstance = null;

        function initializeCashFlowChart(transactions) {
            const ctx = document.getElementById('cash-flow-chart')?.getContext('2d');
            if (!ctx) return;

            // Destroy previous chart instance if exists
            if (cashFlowChartInstance) {
                cashFlowChartInstance.destroy();
            }

            // Calculate data based on *filtered* transactions
             const income = transactions .filter(t => t.type === 'deposit') .reduce((sum, t) => sum + t.amount, 0);
             const expenses = Math.abs(transactions .filter(t => t.type === 'withdrawal') .reduce((sum, t) => sum + t.amount, 0));
             const netTransfers = transactions .filter(t => t.type === 'transfer') .reduce((sum, t) => sum + t.amount, 0);
             const fees = Math.abs(transactions .filter(t => t.type === 'fee') .reduce((sum, t) => sum + t.amount, 0));

             const chartLabels = ['Income', 'Expenses', 'Net Transfers', 'Fees'];
             // Use absolute for pie chart segments, except net transfers can be pos/neg visually
             const chartDataPoints = [income, expenses, Math.abs(netTransfers), fees];

            const backgroundColors = [
                'rgba(16, 185, 129, 0.7)', // Income (Success)
                'rgba(239, 68, 68, 0.7)',  // Expenses (Danger)
                netTransfers >= 0 ? 'rgba(14, 165, 233, 0.7)' : 'rgba(245, 158, 11, 0.7)', // Transfers (Accent/Warning)
                'rgba(245, 158, 11, 0.7)' // Fees (Warning)
             ];
             const borderColors = [
                 'rgb(16, 185, 129)',
                 'rgb(239, 68, 68)',
                 netTransfers >= 0 ? 'rgb(14, 165, 233)' : 'rgb(245, 158, 11)',
                 'rgb(245, 158, 11)'
             ];

             cashFlowChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartDataPoints,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { padding: 15 } },
                        tooltip: { /* Tooltip options remain the same */
                             backgroundColor: 'rgba(255, 255, 255, 0.95)', titleColor: '#0f172a', bodyColor: '#334155', bodyFont: { size: 14 }, borderColor: '#e2e8f0', borderWidth: 1, padding: 12,
                             callbacks: {
                                 label: function(context) {
                                     let label = context.label || '';
                                     if (label) { label += ': '; }
                                     const rawValue = context.raw; // Value shown in pie (abs for most)
                                     let actualValue = rawValue;
                                     // Get original signed value for display
                                     if (context.label === 'Income') actualValue = income;
                                     else if (context.label === 'Expenses') actualValue = expenses * -1;
                                     else if (context.label === 'Net Transfers') actualValue = netTransfers;
                                     else if (context.label === 'Fees') actualValue = fees * -1;

                                     const total = context.dataset.data.reduce((a, b) => a + Math.abs(b), 0);
                                     const percentage = total !== 0 ? Math.round(Math.abs(actualValue) / total * 100) : 0;

                                     label += currencyFormatter.format(actualValue);
                                     if (total !== 0) { label += ` (${percentage}%)`; }
                                     return label;
                                 }
                             }
                        }
                    }
                }
            });
        }

        function initializeAccountsChart() { // Using static data for now
            const ctx = document.getElementById('accounts-chart')?.getContext('2d');
            if (!ctx) return;

            // Destroy previous instance
            if (accountsChartInstance) {
                accountsChartInstance.destroy();
            }

            // Check if data is valid before creating chart
            if (!accountsData || !accountsData.labels || !accountsData.balances || accountsData.labels.length !== accountsData.balances.length) {
                console.error("Invalid accountsData for chart.");
                // Optionally display an error message on the chart canvas area
                return;
            }


            accountsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: accountsData.labels,
                    datasets: [{
                        label: 'Account Balance',
                        data: accountsData.balances,
                        backgroundColor: accountsData.balances.map(b => b >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                        borderColor: accountsData.balances.map(b => b >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)'),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: { /* Options remain the same */
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    scales: { x: { grid: { color: 'rgba(226, 232, 240, 0.5)' }, ticks: { callback: function(value) { return '$' + value.toLocaleString(); } } }, y: { grid: { display: false } } },
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(255, 255, 255, 0.95)', titleColor: '#0f172a', bodyColor: '#334155', bodyFont: { size: 14 }, borderColor: '#e2e8f0', borderWidth: 1, padding: 12, callbacks: { title: (ti) => ti[0].label + ' Account', label: function(context) { return `Balance: ${currencyFormatter.format(context.raw)}`; } } } }
                }
            });
        }

        function populateTransactionsTable(transactions) {
            const tableBody = document.querySelector('#transactions-table tbody');
            if (!tableBody) return;
            tableBody.innerHTML = ''; // Clear previous content

             // Sort transactions by date descending before populating
             const sortedTransactions = [...transactions].sort((a, b) => {
                // Basic date sort MM/DD/YY - assumes valid format
                const dateA = new Date(`20${a.date.split('/')[2]}`, a.date.split('/')[0] - 1, a.date.split('/')[1]);
                const dateB = new Date(`20${b.date.split('/')[2]}`, b.date.split('/')[0] - 1, b.date.split('/')[1]);
                return dateB - dateA; // Descending
             });

            if (sortedTransactions.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6; // Span all columns
                cell.textContent = 'No transactions found for November 2024.';
                cell.style.textAlign = 'center';
                cell.style.padding = '2rem';
                cell.style.color = 'var(--text-tertiary)';
                return;
            }


            sortedTransactions.forEach(transaction => {
                const row = tableBody.insertRow();

                // Extract short account name and determine icon color (similar logic as before)
                const accountName = transaction.account.split(' (')[0];
                const accountInitials = accountName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
                let accountColor = '#64748b'; // Default
                 if (accountName.includes('RBC Advantage')) accountColor = '#ef4444'; // danger
                 else if (accountName.includes('CIBC Chequing')) accountColor = '#10b981'; // success
                 else if (accountName.includes('RBC Cash Back')) accountColor = '#f59e0b'; // warning
                 else if (accountName.includes('CIBC VISA')) accountColor = '#8b5cf6'; // purple-ish accent
                 else if (accountName.includes('CIBC Savings')) accountColor = '#0ea5e9'; // accent-secondary

                // Map transaction type to badge class
                const badgeClass = `badge-${transaction.type}`; // e.g., badge-withdrawal

                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td>
                        <div class="account-cell">
                            <div class="account-icon" style="background-color: ${accountColor};">${accountInitials}</div>
                            <div>${accountName}</div>
                        </div>
                    </td>
                    <td>${transaction.description}</td>
                    <td>${transaction.category || 'Uncategorized'}</td>
                    <td> <span class="tx-badge ${badgeClass}"> ${transaction.type} </span> </td>
                    <td class="${transaction.amount >= 0 ? 'positive' : 'negative'}">
                        ${currencyFormatter.format(transaction.amount)}
                    </td>
                `;
            });
        }

        // --- Main Execution Logic ---
        document.addEventListener('DOMContentLoaded', function() {

             // --- Chart.js Global Config (Optional) ---
             Chart.defaults.font.family = "'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif";
             Chart.defaults.color = '#64748b'; // --text-tertiary
             Chart.defaults.plugins.legend.labels.usePointStyle = true;
             Chart.defaults.plugins.legend.labels.pointStyle = 'circle';

            // --- Fetch and Process Data ---
            showMessage('info', `Loading transactions from ${CSV_FILE_PATH}...`);

            fetch(CSV_FILE_PATH)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - Could not load ${CSV_FILE_PATH}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    try {
                        const allTransactions = parseCSV(csvText);
                        novemberTransactions = filterTransactionsByMonth(allTransactions, TARGET_MONTH, TARGET_YEAR_SHORT);

                        if (novemberTransactions.length === 0) {
                            showMessage('warning', `No transactions found for November ${TARGET_YEAR}. Displaying empty dashboard.`);
                        } else {
                            clearMessage(); // Clear loading message on success
                        }

                        // --- Initialize Dashboard with loaded data ---
                        updateDashboardHeader(novemberTransactions);
                        updateSummaryCards(novemberTransactions);
                        initializeCashFlowChart(novemberTransactions);
                        initializeAccountsChart(); // Uses static data
                        populateTransactionsTable(novemberTransactions);

                    } catch (parseError) {
                        console.error("Error parsing CSV:", parseError);
                        showMessage('error', `Error processing CSV data: ${parseError.message}`);
                         // Initialize with empty data to prevent JS errors later
                        updateDashboardHeader([]);
                        updateSummaryCards([]);
                        initializeCashFlowChart([]);
                        initializeAccountsChart(); // Still try to init static chart
                        populateTransactionsTable([]);
                    }
                })
                .catch(error => {
                    console.error('Error fetching or processing CSV:', error);
                    showMessage('error', `Failed to load or process transaction data: ${error.message}. Please ensure '${CSV_FILE_PATH}' is in the same directory and the file is accessible.`);
                     // Initialize with empty data
                     updateDashboardHeader([]);
                     updateSummaryCards([]);
                     initializeCashFlowChart([]);
                     initializeAccountsChart();
                     populateTransactionsTable([]);
                });

        }); // End DOMContentLoaded listener

        // --- Sidebar Toggle JS (COPIED FROM index.html - unchanged) ---
         const sidebar = document.getElementById('sidebar');
         const toggleButton = document.getElementById('sidebar-toggle');
         if (toggleButton && sidebar) {
             toggleButton.addEventListener('click', () => { sidebar.classList.toggle('active'); });
             document.addEventListener('click', function(event) {
                 const isClickInsideSidebar = sidebar.contains(event.target);
                 const isClickOnToggle = toggleButton.contains(event.target);
                 if (window.innerWidth <= 768 && !isClickInsideSidebar && !isClickOnToggle && sidebar.classList.contains('active')) {
                     sidebar.classList.remove('active');
                 }
             });
         }
    </script>
</body>
</html>
--- END OF FILE financial-dashboard.html ---
